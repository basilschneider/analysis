#!/usr/bin/env bash

# Wrapper script to create n-tuples from MiniAODs

set -e -o pipefail

dir=~/analysis/datasets/
out=output
tree=treeProducerSusySingleLepton
nEvts=-1
condor=false
debug=false

usage(){
    echo "Usage: $0 [option]"
    echo "where [option] can be"
    echo "-h                 Show this help"
    echo "-o output          Set name of output directory (default: $out)"
    echo "-d dir             Path to output directory (default: $dir)"
    echo "-t tree            Path to tree in eos directory (default: $tree)"
    echo "-n N               Process N events (default: $nEvts)"
    echo "-c                 Run on condor (default: $condor)"
    echo "--debug            Debug messages (default: $debug)"
}


parseOptions(){

    # Check for flags
    OPT=$(getopt \
        --options ho:d:t:n:c \
        --long debug \
        --name "$0" \
        -- "$@"
    )

    eval set -- "${OPT}"

    while true; do
        case "${1}" in
            -h) usage
                exit 0;;
            -o) out="${2}"
                shift 2;;
            -d) dir="${2}"
                shift 2;;
            -t) tree="${2}"
                shift 2;;
            -n) nEvts="${2}"
                shift 2;;
            -c) condor=true
                shift 1;;
            --debug) debug=true
                shift 1;;
            --) shift
                break;;
        esac
    done

    # Check for positional arguments
    if [ $# -ne 0 ]; then
        usage
        exit 1
    fi
}

produceTrees(){

    # Commands to be executed later
    cmd=()

    if [ "${condor}" == true ]; then
        cmdCondor
    else
        cmdLocal
    fi
}

cmdLocal(){
    cmd+=('cd ${CMSSW_BASE}/src/CMGTools/SUSYAnalysis/cfg/')
    cmd+=('heppy ${dir}/${out} run_susySingleLepton_v2_cfg.py -p 0 -f')
    if [ ${nEvts} -ge 0 ]; then
        cmdadd '-N ${nEvts}'
    fi
}

# Append to last cmd entry
cmdadd(){
    cmd[${#cmd[@]}-1]+=" $1"
}

# Invoke cmd command
invokeCmd(){
    # Invoke command(s) in subshell
    (
        for c in "${cmd[@]}"; do
            if [ "$debug" == true ]; then
                echo "$c"
            fi
            eval "$c"
        done
    )
}

main(){
    parseOptions "$@"
    produceTrees
    invokeCmd
}

main "$@"
